

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>geoml.likelihood &mdash; geoML 0.3.5 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=ba50482b"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            geoML
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">geoml</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">geoML</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">geoml.likelihood</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for geoml.likelihood</h1><div class="highlight"><pre>
<span></span><span class="c1"># geoML - machine learning models for geospatial data</span>
<span class="c1"># Copyright (C) 2020  Ítalo Gomes Gonçalves</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR a PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="c1"># import numpy as np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">helmert</span> <span class="k">as</span> <span class="n">_helmert</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_copy</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">geoml.warping</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_warp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geoml.parameter</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_gpr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geoml.tftools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_tftools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geoml.interpolation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_gint</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_tf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow_probability</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_tfp</span>

<span class="n">_tfd</span> <span class="o">=</span> <span class="n">_tfp</span><span class="o">.</span><span class="n">distributions</span>

<span class="n">_ROOTS_8</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="mf">3.811869902073221168547189e-1</span><span class="p">,</span>
    <span class="mf">1.157193712446780194720766</span><span class="p">,</span>
    <span class="mf">1.981656756695842925854631</span><span class="p">,</span>
    <span class="mf">2.930637420257244019223503</span>
<span class="p">])</span>
<span class="n">_ROOTS_8</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="o">-</span><span class="n">_ROOTS_8</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">_ROOTS_8</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">_WEIGHTS_8</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="mf">6.611470125582412910303848e-1</span><span class="p">,</span>
    <span class="mf">2.078023258148918795432488e-1</span><span class="p">,</span>
    <span class="mf">1.707798300741347545620225e-2</span><span class="p">,</span>
    <span class="mf">1.996040722113676192060810e-4</span>
<span class="p">])</span>
<span class="n">_WEIGHTS_8</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_WEIGHTS_8</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">_WEIGHTS_8</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">_WEIGHTS_8</span> <span class="o">=</span> <span class="n">_WEIGHTS_8</span> <span class="o">/</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">_WEIGHTS_8</span><span class="p">)</span>

<span class="n">_ROOTS_64</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="mf">1.383022449870097241150498e-1</span><span class="p">,</span>
    <span class="mf">4.149888241210786845769291e-1</span><span class="p">,</span>
    <span class="mf">6.919223058100445772682193e-1</span><span class="p">,</span>
    <span class="mf">9.692694230711780167435415e-1</span><span class="p">,</span>
    <span class="mf">1.247200156943117940693565</span><span class="p">,</span>
    <span class="mf">1.525889140209863662948970</span><span class="p">,</span>
    <span class="mf">1.805517171465544918908774</span><span class="p">,</span>
    <span class="mf">2.086272879881762020832563</span><span class="p">,</span>
    <span class="mf">2.368354588632401404111511</span><span class="p">,</span>
    <span class="mf">2.651972435430635011005458</span><span class="p">,</span>
    <span class="mf">2.937350823004621809685339</span><span class="p">,</span>
    <span class="mf">3.224731291992035725848171</span><span class="p">,</span>
    <span class="mf">3.514375935740906211539951</span><span class="p">,</span>
    <span class="mf">3.806571513945360461165972</span><span class="p">,</span>
    <span class="mf">4.101634474566656714970981</span><span class="p">,</span>
    <span class="mf">4.399917168228137647767933</span><span class="p">,</span>
    <span class="mf">4.701815647407499816097538</span><span class="p">,</span>
    <span class="mf">5.007779602198768196443703</span><span class="p">,</span>
    <span class="mf">5.318325224633270857323650</span><span class="p">,</span>
    <span class="mf">5.634052164349972147249920</span><span class="p">,</span>
    <span class="mf">5.955666326799486045344567</span><span class="p">,</span>
    <span class="mf">6.284011228774828235418093</span><span class="p">,</span>
    <span class="mf">6.620112262636027379036660</span><span class="p">,</span>
    <span class="mf">6.965241120551107529242642</span><span class="p">,</span>
    <span class="mf">7.321013032780949201189569</span><span class="p">,</span>
    <span class="mf">7.689540164040496828447804</span><span class="p">,</span>
    <span class="mf">8.073687285010225225858791</span><span class="p">,</span>
    <span class="mf">8.477529083379863090564166</span><span class="p">,</span>
    <span class="mf">8.907249099964769757295973</span><span class="p">,</span>
    <span class="mf">9.373159549646721162545652</span><span class="p">,</span>
    <span class="mf">9.895287586829539021204461</span><span class="p">,</span>
    <span class="mf">1.052612316796054588332683e1</span>
<span class="p">])</span>
<span class="n">_ROOTS_64</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="o">-</span><span class="n">_ROOTS_64</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">_ROOTS_64</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">_WEIGHTS_64</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="p">[</span>
    <span class="mf">2.713774249413039779455939e-1</span><span class="p">,</span>
    <span class="mf">2.329947860626780466505551e-1</span><span class="p">,</span>
    <span class="mf">1.716858423490837020007199e-1</span><span class="p">,</span>
    <span class="mf">1.084983493061868406330207e-1</span><span class="p">,</span>
    <span class="mf">5.873998196409943454968617e-2</span><span class="p">,</span>
    <span class="mf">2.720312895368891845383354e-2</span><span class="p">,</span>
    <span class="mf">1.075604050987913704946467e-2</span><span class="p">,</span>
    <span class="mf">3.622586978534458760667954e-3</span><span class="p">,</span>
    <span class="mf">1.036329099507577663456693e-3</span><span class="p">,</span>
    <span class="mf">2.509838985130624860823502e-4</span><span class="p">,</span>
    <span class="mf">5.125929135786274660821669e-5</span><span class="p">,</span>
    <span class="mf">8.788499230850359181443633e-6</span><span class="p">,</span>
    <span class="mf">1.258340251031184576157783e-6</span><span class="p">,</span>
    <span class="mf">1.495532936727247061102391e-7</span><span class="p">,</span>
    <span class="mf">1.465125316476109354926553e-8</span><span class="p">,</span>
    <span class="mf">1.173616742321549343542451e-9</span><span class="p">,</span>
    <span class="mf">7.615217250145451353314936e-11</span><span class="p">,</span>
    <span class="mf">3.959177766947723927236259e-12</span><span class="p">,</span>
    <span class="mf">1.628340730709720362084230e-13</span><span class="p">,</span>
    <span class="mf">5.218623726590847522957562e-15</span><span class="p">,</span>
    <span class="mf">1.280093391322438041639503e-16</span><span class="p">,</span>
    <span class="mf">2.351884710675819116957565e-18</span><span class="p">,</span>
    <span class="mf">3.152254566503781416121198e-20</span><span class="p">,</span>
    <span class="mf">2.982862784279851154478560e-22</span><span class="p">,</span>
    <span class="mf">1.911706883300642829958367e-24</span><span class="p">,</span>
    <span class="mf">7.861797788925910369099620e-27</span><span class="p">,</span>
    <span class="mf">1.929103595464966850301878e-29</span><span class="p">,</span>
    <span class="mf">2.549660899112999256604646e-32</span><span class="p">,</span>
    <span class="mf">1.557390624629763802300262e-35</span><span class="p">,</span>
    <span class="mf">3.421138011255740504327060e-39</span><span class="p">,</span>
    <span class="mf">1.679747990108159218666209e-43</span><span class="p">,</span>
    <span class="mf">5.535706535856942820575202e-49</span>
<span class="p">])</span>
<span class="n">_WEIGHTS_64</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_WEIGHTS_64</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">_WEIGHTS_64</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">_WEIGHTS_64</span> <span class="o">=</span> <span class="n">_WEIGHTS_64</span> <span class="o">/</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">_WEIGHTS_64</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_Likelihood</span><span class="p">(</span><span class="n">_gpr</span><span class="o">.</span><span class="n">Parametric</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_monte_carlo</span> <span class="o">=</span> <span class="n">use_monte_carlo</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="n">include_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik_from_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_from_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_ContinuousLikelihood</span><span class="p">(</span><span class="n">_Likelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer for continuous likelihoods.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        warping : geoml.warping.Warping</span>
<span class="sd">            A Warping object that normalizes the data values.</span>
<span class="sd">        use_monte_carlo : bool</span>
<span class="sd">            Whether to use Monte Carlo samples in training, instead of the</span>
<span class="sd">            probability density function. Used mainly to maintain consistency</span>
<span class="sd">            while using other likelihood for another variable, which does not</span>
<span class="sd">            have an analytical form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">(</span><span class="n">warping</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spline</span> <span class="o">=</span> <span class="n">_gint</span><span class="o">.</span><span class="n">MonotonicCubicSpline</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">y_warped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y_derivative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">log_derivative</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_derivative</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_monte_carlo</span><span class="p">:</span>
            <span class="n">distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_distribution</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">y_warped</span><span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
                <span class="n">log_density</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_ROOTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">mu</span>  <span class="c1"># [n_data, n_vals]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_WEIGHTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_distribution</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">y_warped</span><span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">lik</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">((</span><span class="n">log_density</span> <span class="o">+</span> <span class="n">log_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lik</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">include_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_ROOTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">mu</span>  <span class="c1"># [n_data, n_vals]</span>
        <span class="c1"># w = _tf.expand_dims(_WEIGHTS, axis=0)</span>

        <span class="c1"># distribution = self._make_distribution(vals)</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">MixtureSameFamily</span><span class="p">(</span>
            <span class="n">_tfd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">_WEIGHTS_64</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_distribution</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">lik_var</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">variance</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lik_var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="c1"># weights = weights**2</span>

        <span class="n">sims</span> <span class="o">=</span> <span class="n">sims</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">include_noise</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">sims</span><span class="p">)</span>
            <span class="n">sims</span> <span class="o">=</span> <span class="n">sims</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">white_noise</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span>
               <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
               <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">sims</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span>
               <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span>
               <span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">prob_fn</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
            <span class="c1"># p = _tf.reduce_sum(p * w, axis=1)</span>
            <span class="k">return</span> <span class="n">p</span>

        <span class="k">if</span> <span class="n">quantiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="n">prob_fn</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>

            <span class="c1"># single point case</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">prob</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">prob</span><span class="p">)</span>

            <span class="c1"># out[&quot;probabilities&quot;] = _tf.squeeze(prob)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;probabilities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>

        <span class="c1"># def quant_fn(p):</span>
        <span class="c1">#     # p = _tf.expand_dims(p, 0)</span>
        <span class="c1">#     q = self.warping.backward(distribution.quantile(p))</span>
        <span class="c1">#     q = _tf.reduce_sum(q * w, axis=1)</span>
        <span class="c1">#     return q</span>

        <span class="k">if</span> <span class="n">probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warped_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="n">prob_vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">distribution</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                   <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>

            <span class="n">n_data</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">warped_vals</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spline</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">prob_vals</span><span class="p">,</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">warped_vals</span><span class="p">),</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_data</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="c1"># quant = _tf.map_fn(quant_fn, probabilities)</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">quant</span><span class="p">)</span>

            <span class="c1"># # single point case</span>
            <span class="c1"># quant = _tf.cond(</span>
            <span class="c1">#     _tf.less(_tf.rank(quant), 2),</span>
            <span class="c1">#     lambda: _tf.expand_dims(quant, 0),</span>
            <span class="c1">#     lambda: quant)</span>

            <span class="c1"># out[&quot;quantiles&quot;] = _tf.squeeze(quant)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;quantiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">white_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="n">n_data</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_distribution</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_data</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<div class="viewcode-block" id="Gaussian">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Gaussian">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Gaussian</span><span class="p">(</span><span class="n">_ContinuousLikelihood</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gaussian likelihood.</span>

<span class="sd">    Equivalent to a squared error model. The latent variable maps to the mean,</span>
<span class="sd">    while the noise variance is a parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">warping</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;noise&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()))</span></div>



<div class="viewcode-block" id="Laplace">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Laplace">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Laplace</span><span class="p">(</span><span class="n">_ContinuousLikelihood</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Laplace likelihood.</span>

<span class="sd">    Equivalent to a linear error model. The latent variable maps to the mean,</span>
<span class="sd">    while the distribution&#39;s scale factor is a parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">warping</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Laplace</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span></div>



<div class="viewcode-block" id="Gamma">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Gamma">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Gamma</span><span class="p">(</span><span class="n">_ContinuousLikelihood</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gamma likelihood.</span>

<span class="sd">    Used for strictly positive variables. The latent variable is shifted by a</span>
<span class="sd">    parameter and then mapped to the distribution&#39;s shape. The rate parameter</span>
<span class="sd">    is fixed at 1.0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">warping</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;mean_alpha&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">RealParameter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="n">mean_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;mean_alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Gamma</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="n">mean_alpha</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                          <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span></div>



<div class="viewcode-block" id="Beta">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Beta">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Beta</span><span class="p">(</span><span class="n">_ContinuousLikelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concentration</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">use_monte_carlo</span><span class="o">=</span><span class="n">use_monte_carlo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;concentration&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span>
            <span class="n">concentration</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)))</span>
        <span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;concentration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">loc</span> <span class="o">*</span> <span class="n">concentration</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">loc</span><span class="p">)</span> <span class="o">*</span> <span class="n">concentration</span>
        <span class="k">return</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span></div>



<div class="viewcode-block" id="StudentT">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.StudentT">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">StudentT</span><span class="p">(</span><span class="n">_ContinuousLikelihood</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Student-T likelihood.</span>

<span class="sd">    A heavy-tailed distribution. The latent variable maps to the mean,</span>
<span class="sd">    while the scale and degrees of freedom are parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">warping</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;df&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">2.01</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">StudentT</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;df&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">(),</span>
            <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span></div>



<div class="viewcode-block" id="EpsilonInsensitive">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.EpsilonInsensitive">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EpsilonInsensitive</span><span class="p">(</span><span class="n">_ContinuousLikelihood</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Epsilon-insensitive likelihood.</span>

<span class="sd">    Similar to the Laplace likelihood, with an addition `epsilon` parameter,</span>
<span class="sd">    below which error are not penalized. Can be used to obtain a model similar</span>
<span class="sd">    to the Support Vector Machine.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">warping</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;epsilon&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;c_rate&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">))</span>

<div class="viewcode-block" id="EpsilonInsensitive.log_lik">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.EpsilonInsensitive.log_lik">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">y_warped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y_derivative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">log_derivative</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_derivative</span><span class="p">)</span>

        <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">c_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;c_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_monte_carlo</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">y_centered</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_warped</span> <span class="o">-</span> <span class="n">samples</span><span class="p">)</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">y_centered</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">),</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y_centered</span><span class="p">),</span>
                <span class="o">-</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_centered</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">log_density</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span><span class="p">))</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">log_density</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_ROOTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">mu</span>  <span class="c1"># [n_data, n_vals]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_WEIGHTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">y_centered</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_warped</span> <span class="o">-</span> <span class="n">vals</span><span class="p">)</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">y_centered</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">),</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y_centered</span><span class="p">),</span>
                <span class="o">-</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_centered</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">log_density</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span><span class="p">))</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_logsumexp</span><span class="p">(</span>
                <span class="n">log_density</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">lik</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">log_density</span> <span class="o">+</span> <span class="n">log_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lik</span></div>


<div class="viewcode-block" id="EpsilonInsensitive.cdf">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.EpsilonInsensitive.cdf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">c_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;c_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">val_1</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">c_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span> <span class="o">/</span> <span class="n">c_rate</span>
        <span class="n">val_2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span> <span class="o">+</span> <span class="n">x</span> <span class="o">-</span> <span class="n">epsilon</span>
        <span class="n">val_3</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">c_rate</span> \
                <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">)))</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">epsilon</span><span class="p">),</span> <span class="n">val_2</span><span class="p">,</span> <span class="n">val_1</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">),</span> <span class="n">val_3</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="n">prob</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prob</span></div>


<div class="viewcode-block" id="EpsilonInsensitive.inv_cdf">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.EpsilonInsensitive.inv_cdf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">inv_cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">c_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;c_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">area</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span><span class="p">)</span>
        <span class="n">p_1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">area</span>
        <span class="n">p_2</span> <span class="o">=</span> <span class="n">p_1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">/</span> <span class="n">area</span>

        <span class="n">val_1</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">area</span> <span class="o">*</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="n">c_rate</span> <span class="o">-</span> <span class="n">epsilon</span>
        <span class="n">val_2</span> <span class="o">=</span> <span class="n">area</span> <span class="o">*</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span> <span class="o">-</span> <span class="n">epsilon</span>
        <span class="n">val_3</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">area</span> <span class="o">*</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">))</span> <span class="o">/</span> <span class="n">c_rate</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_1</span><span class="p">),</span> <span class="n">val_2</span><span class="p">,</span> <span class="n">val_1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_2</span><span class="p">),</span> <span class="n">val_3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="EpsilonInsensitive.variance">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.EpsilonInsensitive.variance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;c_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">c</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span> <span class="o">/</span> <span class="n">d</span></div>


<div class="viewcode-block" id="EpsilonInsensitive.white_noise">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.EpsilonInsensitive.white_noise">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">white_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">minval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cdf</span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample</span></div>


<div class="viewcode-block" id="EpsilonInsensitive.predict">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.EpsilonInsensitive.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">lik_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lik_var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span>
               <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
               <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">sims</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span>
               <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span>
               <span class="p">}</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_ROOTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">mu</span>  <span class="c1"># [n_data, n_vals]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_WEIGHTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">prob_fn</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="o">-</span> <span class="n">vals</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span>

        <span class="k">if</span> <span class="n">quantiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="n">prob_fn</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>

            <span class="c1"># single point case</span>
            <span class="c1"># prob = _tf.cond(</span>
            <span class="c1">#     _tf.less(_tf.rank(prob), 2),</span>
            <span class="c1">#     lambda: _tf.expand_dims(prob, 0),</span>
            <span class="c1">#     lambda: prob)</span>

            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;probabilities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>

        <span class="c1"># def quant_fn(p):</span>
        <span class="c1">#     p = _tf.expand_dims(p, 0)</span>
        <span class="c1">#     q = distribution.quantile(_tf.squeeze(self.warping.backward(p)))</span>
        <span class="c1">#     q = _tf.reduce_sum(q * w, axis=1)</span>
        <span class="c1">#     return q</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">prob_fn_2</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">vals</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">p</span>

            <span class="n">prob_vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="n">prob_fn_2</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>

            <span class="n">n_data</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">vals</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spline</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">prob_vals</span><span class="p">,</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">vals</span><span class="p">)),</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_data</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="c1"># quant = _tf.map_fn(quant_fn, probabilities)</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">quant</span><span class="p">)</span>

            <span class="c1"># single point case</span>
            <span class="c1"># quant = _tf.cond(</span>
            <span class="c1">#     _tf.less(_tf.rank(quant), 2),</span>
            <span class="c1">#     lambda: _tf.expand_dims(quant, 0),</span>
            <span class="c1">#     lambda: quant)</span>

            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;quantiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant</span>

        <span class="k">return</span> <span class="n">out</span></div>
</div>



<div class="viewcode-block" id="Huber">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Huber">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Huber</span><span class="p">(</span><span class="n">_ContinuousLikelihood</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Huber likelihood.</span>

<span class="sd">    Based on the Huber loss.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">warping</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<div class="viewcode-block" id="Huber.log_lik">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Huber.log_lik">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">y_warped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y_derivative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">log_derivative</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_derivative</span><span class="p">)</span>

        <span class="n">thr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">thr</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">thr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">thr</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_monte_carlo</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">y_centered</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_warped</span> <span class="o">-</span> <span class="n">samples</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">y_centered</span><span class="p">,</span> <span class="n">thr</span><span class="p">),</span>
                <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">y_centered</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span> <span class="n">thr</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_centered</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">thr</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">log_density</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">log_density</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_ROOTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">mu</span>  <span class="c1"># [n_data, n_vals]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_WEIGHTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">y_centered</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_warped</span> <span class="o">-</span> <span class="n">vals</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">y_centered</span><span class="p">,</span> <span class="n">thr</span><span class="p">),</span>
                <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">y_centered</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
                <span class="o">-</span> <span class="n">thr</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_centered</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">thr</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">log_density</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_logsumexp</span><span class="p">(</span>
                <span class="n">log_density</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">lik</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">log_density</span> <span class="o">+</span> <span class="n">log_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lik</span></div>


<div class="viewcode-block" id="Huber.cdf">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Huber.cdf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">thr</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">thr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">thr</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">std</span>

        <span class="n">val_1</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">thr</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">thr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">thr</span>
        <span class="n">val_2</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">thr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">thr</span> \
                <span class="o">+</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">thr</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                                          <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">val_3</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">thr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">thr</span> \
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">thr</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> \
                <span class="o">+</span> <span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">thr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span>
                   <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">thr</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">thr</span><span class="o">*</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">thr</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">thr</span><span class="p">),</span> <span class="n">val_2</span><span class="p">,</span> <span class="n">val_1</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">thr</span><span class="p">),</span> <span class="n">val_3</span><span class="p">,</span> <span class="n">prob</span><span class="p">)</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="n">prob</span> <span class="o">/</span> <span class="n">norm</span>
        <span class="k">return</span> <span class="n">prob</span></div>


<div class="viewcode-block" id="Huber.variance">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Huber.variance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">variance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">thr</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">thr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">thr</span><span class="p">)</span>

        <span class="n">n1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">thr</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                  <span class="o">-</span> <span class="n">thr</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">thr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">thr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> \
             <span class="o">*</span> <span class="p">(</span><span class="n">thr</span> <span class="o">+</span> <span class="mi">2</span><span class="o">/</span><span class="n">thr</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">thr</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">std</span><span class="o">**</span><span class="mi">2</span></div>


<div class="viewcode-block" id="Huber.predict">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Huber.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">lik_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lik_var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span>
               <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
               <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">sims</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span>
               <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span>
               <span class="p">}</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_ROOTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">mu</span>  <span class="c1"># [n_data, n_vals]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_WEIGHTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">prob_fn</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="o">-</span> <span class="n">vals</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span>

        <span class="k">if</span> <span class="n">quantiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="n">prob_fn</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>

            <span class="c1"># single point case</span>
            <span class="c1"># prob = _tf.cond(</span>
            <span class="c1">#     _tf.less(_tf.rank(prob), 2),</span>
            <span class="c1">#     lambda: _tf.expand_dims(prob, 0),</span>
            <span class="c1">#     lambda: prob)</span>

            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;probabilities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>

        <span class="c1"># def quant_fn(p):</span>
        <span class="c1">#     p = _tf.expand_dims(p, 0)</span>
        <span class="c1">#     q = distribution.quantile(_tf.squeeze(self.warping.backward(p)))</span>
        <span class="c1">#     q = _tf.reduce_sum(q * w, axis=1)</span>
        <span class="c1">#     return q</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">prob_fn_2</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">vals</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">p</span>

            <span class="n">prob_vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="n">prob_fn_2</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>

            <span class="n">n_data</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">vals</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spline</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">prob_vals</span><span class="p">,</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">vals</span><span class="p">)),</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_data</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="c1"># quant = _tf.map_fn(quant_fn, probabilities)</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">quant</span><span class="p">)</span>

            <span class="c1"># single point case</span>
            <span class="c1"># quant = _tf.cond(</span>
            <span class="c1">#     _tf.less(_tf.rank(quant), 2),</span>
            <span class="c1">#     lambda: _tf.expand_dims(quant, 0),</span>
            <span class="c1">#     lambda: quant)</span>

            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;quantiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant</span>

        <span class="k">return</span> <span class="n">out</span></div>
</div>



<div class="viewcode-block" id="HeteroscedasticGaussian">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.HeteroscedasticGaussian">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HeteroscedasticGaussian</span><span class="p">(</span><span class="n">_ContinuousLikelihood</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Heteroscedastic Gaussian likelihood.</span>

<span class="sd">    Allows the modeling of spatially-dependent noise. Requires two latent</span>
<span class="sd">    variables, one for the mean and other for the log-variance. The analytical</span>
<span class="sd">    form uses approximations; better results are obtained by Monte Carlo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Identity</span><span class="p">(),</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">warping</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="mi">2</span>

<div class="viewcode-block" id="HeteroscedasticGaussian.log_lik">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.HeteroscedasticGaussian.log_lik">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">y_warped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y_derivative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">log_derivative</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y_derivative</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_monte_carlo</span><span class="p">:</span>
            <span class="n">samples_mean</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">samples_noise</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span>

            <span class="n">distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_distribution</span><span class="p">(</span><span class="n">samples_mean</span><span class="p">,</span> <span class="n">samples_noise</span><span class="p">)</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">y_warped</span><span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
                <span class="n">log_density</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># double integral</span>
            <span class="n">loc_mean</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">loc_var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">noise_mean</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">noise_var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">vals_1</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">loc_var</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> \
                     <span class="o">*</span> <span class="n">_ROOTS_8</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">loc_mean</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">vals_2</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">noise_var</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> \
                     <span class="o">*</span> <span class="n">_ROOTS_8</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">noise_mean</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">_WEIGHTS_8</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">_WEIGHTS_8</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">/</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

            <span class="n">distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_distribution</span><span class="p">(</span><span class="n">vals_1</span><span class="p">,</span> <span class="n">vals_2</span><span class="p">)</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">y_warped</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">lik</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">((</span><span class="n">log_density</span> <span class="o">+</span> <span class="n">log_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lik</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

<div class="viewcode-block" id="HeteroscedasticGaussian.predict">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.HeteroscedasticGaussian.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">probabilities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># double integral</span>
        <span class="n">loc_mean</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">loc_var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">noise_mean</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">noise_var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">vals_1</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">loc_var</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> \
                 <span class="o">*</span> <span class="n">_ROOTS_8</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">loc_mean</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">vals_2</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">noise_var</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> \
                 <span class="o">*</span> <span class="n">_ROOTS_8</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">noise_mean</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">_WEIGHTS_8</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">_WEIGHTS_8</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">vals_1</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">vals_1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">]),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">8</span><span class="p">])</span>
        <span class="n">vals_2</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">vals_2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">8</span><span class="p">])</span>

        <span class="n">distribution</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">MixtureSameFamily</span><span class="p">(</span>
            <span class="n">_tfd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">w</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_distribution</span><span class="p">(</span><span class="n">vals_1</span><span class="p">,</span> <span class="n">vals_2</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">lik_var</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">variance</span><span class="p">()</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">explained_var</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lik_var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">loc_mean</span><span class="p">,</span>
               <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">loc_var</span><span class="p">,</span>
               <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">sims</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span>
               <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span>
               <span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">prob_fn</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">q</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">p</span>

        <span class="k">if</span> <span class="n">quantiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="n">prob_fn</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>

            <span class="c1"># single point case</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">prob</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">prob</span><span class="p">)</span>

            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;probabilities&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>

        <span class="k">if</span> <span class="n">probabilities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">101</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">loc_var</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">loc_mean</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">warped_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="n">prob_vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">distribution</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                   <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>

            <span class="n">n_data</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">warped_vals</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spline</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
                <span class="n">prob_vals</span><span class="p">,</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">warped_vals</span><span class="p">),</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_data</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="n">quant</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">quant</span><span class="p">)</span>

            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;quantiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quant</span>

        <span class="k">return</span> <span class="n">out</span></div>
</div>



<div class="viewcode-block" id="HeteroscedasticLaplace">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.HeteroscedasticLaplace">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HeteroscedasticLaplace</span><span class="p">(</span><span class="n">HeteroscedasticGaussian</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Laplace</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span></div>



<div class="viewcode-block" id="Bernoulli">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Bernoulli">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Bernoulli</span><span class="p">(</span><span class="n">_Likelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sharpness</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bernoulli likelihood.</span>

<span class="sd">        Used for binary categorical variables.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shift : double</span>
<span class="sd">            How much to favor the positive or negative class. Value between</span>
<span class="sd">            -5 and 5.</span>
<span class="sd">        sharpness : int</span>
<span class="sd">            Data augmentation. The weight of the data is multiplied by this</span>
<span class="sd">            factor. Results in sharper transitions between positive and</span>
<span class="sd">            negative regions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharpness</span> <span class="o">=</span> <span class="n">sharpness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;shift&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">RealParameter</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;slope&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

<div class="viewcode-block" id="Bernoulli.log_lik">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Bernoulli.log_lik">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_ROOTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">mu</span>  <span class="c1"># [n_data, n_vals]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_WEIGHTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;shift&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="c1"># distribution = _tfd.Normal(- shift, _tf.constant(1.0, _tf.float64))</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">slope</span><span class="p">)</span>

        <span class="n">log_density</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">log_cdf</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span> \
                      <span class="o">+</span> <span class="n">distribution</span><span class="o">.</span><span class="n">log_survival_function</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">lik</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lik</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharpness</span></div>


<div class="viewcode-block" id="Bernoulli.predict">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Bernoulli.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_ROOTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">mu</span>  <span class="c1"># [n_data, n_vals]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_WEIGHTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">shift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;shift&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="c1"># distribution = _tfd.Normal(- shift, _tf.constant(1.0, _tf.float64))</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="o">-</span> <span class="n">shift</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">slope</span><span class="p">)</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">prob</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">entropy</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">prob</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
                   <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span><span class="p">)</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span><span class="p">))</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">entropy</span><span class="p">)</span>

        <span class="n">prob_sims</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">sims</span><span class="p">)</span>

        <span class="n">lik_var</span> <span class="o">=</span> <span class="n">prob</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lik_var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="c1"># weights = weights ** 2</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span>
               <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
               <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="n">prob_sims</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
               <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
               <span class="s2">&quot;entropy&quot;</span><span class="p">:</span> <span class="n">entropy</span><span class="p">,</span>
               <span class="s2">&quot;uncertainty&quot;</span><span class="p">:</span> <span class="n">uncertainty</span><span class="p">,</span>
               <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">weights</span><span class="p">)}</span>

        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Bernoulli.one_class">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.Bernoulli.one_class">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sharpness</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">lik</span> <span class="o">=</span> <span class="n">Bernoulli</span><span class="p">(</span><span class="n">shift</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">sharpness</span><span class="o">=</span><span class="n">sharpness</span><span class="p">)</span>
        <span class="n">lik</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;shift&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lik</span></div>
</div>



<div class="viewcode-block" id="BernoulliMaximumMargin">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.BernoulliMaximumMargin">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BernoulliMaximumMargin</span><span class="p">(</span><span class="n">_Likelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span><span class="s2">&quot;c_rate&quot;</span><span class="p">,</span> <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">))</span>

<div class="viewcode-block" id="BernoulliMaximumMargin.log_lik">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.BernoulliMaximumMargin.log_lik">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">c_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;c_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_ROOTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">mu</span>  <span class="c1"># [n_data, n_vals]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_WEIGHTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vals</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">vals</span><span class="p">)),</span>
            <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">vals</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">vals</span><span class="p">))))</span>
        <span class="p">)</span>
        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">lik</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lik</span></div>


<div class="viewcode-block" id="BernoulliMaximumMargin.predict">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.BernoulliMaximumMargin.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_ROOTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var</span><span class="p">)</span> <span class="o">*</span> <span class="n">vals</span> <span class="o">+</span> <span class="n">mu</span>  <span class="c1"># [n_data, n_vals]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_WEIGHTS_64</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">prob</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">prob_sims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">sims</span><span class="p">)</span>

        <span class="n">lik_var</span> <span class="o">=</span> <span class="n">prob</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">explained_var</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lik_var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="c1"># weights = weights ** 2</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span>
               <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
               <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="n">prob_sims</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
               <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
               <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">weights</span><span class="p">)}</span>

        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="BernoulliMaximumMargin.cdf">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.BernoulliMaximumMargin.cdf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">c_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;c_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="n">x</span><span class="p">)),</span>
            <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">prob</span></div>
</div>



<span class="k">class</span><span class="w"> </span><span class="nc">_CategoricalLikelihood</span><span class="p">(</span><span class="n">_Likelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">entropy_and_indicators</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">):</span>
        <span class="n">n_cat</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">log_n</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">n_cat</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
        <span class="n">n_data</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">entropy</span> <span class="o">=</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
            <span class="n">probabilities</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probabilities</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">log_n</span>
        <span class="n">entropy</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">entropy</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">avg_var</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">var</span> <span class="o">*</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">uncertainty</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">avg_var</span> <span class="o">*</span> <span class="n">entropy</span><span class="p">)</span>
        <span class="n">indicators</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probabilities</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">n_data</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">ind_fn</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
            <span class="n">idx_cat</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">tmp_ind</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">tensor_scatter_nd_update</span><span class="p">(</span>
                <span class="n">indicators</span><span class="p">,</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">idx</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">*</span> <span class="n">idx_cat</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">n_data</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">999</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">col</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">tmp_ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ind_skew</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span>
            <span class="n">ind_fn</span><span class="p">,</span> <span class="p">[</span><span class="n">_tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">n_cat</span><span class="p">),</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">indicators</span><span class="p">)],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">ind_skew</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">ind_skew</span><span class="p">)</span>

        <span class="n">lik_var</span> <span class="o">=</span> <span class="n">probabilities</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">probabilities</span><span class="p">)</span>
        <span class="n">lik_var</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">lik_var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">explained_var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">lik_var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">entropy</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="n">ind_skew</span><span class="p">,</span> <span class="n">weights</span>


<div class="viewcode-block" id="CategoricalGaussianIndicator">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.CategoricalGaussianIndicator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CategoricalGaussianIndicator</span><span class="p">(</span><span class="n">_CategoricalLikelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_components</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">sharpness</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">use_monte_carlo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gaussian likelihood for indicator variables.</span>

<span class="sd">        Assumes mutually exclusive categories (i.e. no geological rules),</span>
<span class="sd">        leading to maximum entropy far from the data points. Is capable of</span>
<span class="sd">        dealing with boundary data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_components : int</span>
<span class="sd">            The number of categories.</span>
<span class="sd">        tol : double</span>
<span class="sd">            Normal score tolerance for boundary data.</span>
<span class="sd">        sharpness : int</span>
<span class="sd">            Data augmentation. The weight of the data is multiplied by this</span>
<span class="sd">            factor. Results in sharper transitions between categories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_components</span><span class="p">,</span> <span class="n">use_monte_carlo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharpness</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<div class="viewcode-block" id="CategoricalGaussianIndicator.log_lik">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.CategoricalGaussianIndicator.log_lik">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="n">is_boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_monte_carlo</span><span class="p">:</span>
            <span class="c1"># pos = _tf.where(</span>
            <span class="c1">#     _tf.greater(samples, self.tol),</span>
            <span class="c1">#     _tf.ones_like(samples),</span>
            <span class="c1">#     _tf.zeros_like(samples)</span>
            <span class="c1"># )</span>
            <span class="c1"># neg = _tf.where(</span>
            <span class="c1">#     _tf.less(samples, - self.tol),</span>
            <span class="c1">#     _tf.ones_like(samples),</span>
            <span class="c1">#     _tf.zeros_like(samples)</span>
            <span class="c1"># )</span>
            <span class="c1">#</span>
            <span class="c1"># prob_pos = _tf.reduce_mean(pos, axis=-1)</span>
            <span class="c1"># prob_neg = _tf.reduce_mean(neg, axis=-1)</span>
            <span class="c1"># prob_zero = 1 - prob_neg - prob_pos</span>
            <span class="c1">#</span>
            <span class="c1"># prob_pos = _tf.math.log(prob_pos + 1e-6)</span>
            <span class="c1"># prob_neg = _tf.math.log(prob_neg + 1e-6)</span>
            <span class="c1"># prob_zero = _tf.math.log(prob_zero + 1e-6)</span>

            <span class="n">dist</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1">#self.tol)</span>
            <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_cdf</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
            <span class="n">prob_zero</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span> <span class="o">-</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>

            <span class="c1"># prob_neg = _tf.reduce_mean(prob_neg, axis=-1)</span>
            <span class="c1"># prob_pos = _tf.reduce_mean(prob_pos, axis=-1)</span>
            <span class="c1"># prob_zero = _tf.reduce_mean(prob_zero, axis=-1)</span>

            <span class="n">n_sim</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">samples</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_sim</span><span class="p">])</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                <span class="n">prob_neg</span><span class="p">,</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                          <span class="n">prob_pos</span><span class="p">,</span>
                          <span class="n">prob_zero</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">log_density</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>
            <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_cdf</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
            <span class="n">prob_zero</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span> <span class="o">-</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                <span class="n">prob_neg</span><span class="p">,</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                          <span class="n">prob_pos</span><span class="p">,</span>
                          <span class="n">prob_zero</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># log_density_2 = _tf.math.log(- _tf.math.expm1(log_density))</span>
            <span class="c1"># log_density = log_density - log_density_2 * 1e-4</span>

        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">has_value</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">has_value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">log_density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharpness</span></div>


<div class="viewcode-block" id="CategoricalGaussianIndicator.predict">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.CategoricalGaussianIndicator.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># n_cat = _tf.shape(mu)[1]</span>
        <span class="c1"># n_data = _tf.shape(mu)[0]</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="n">log_prob_positive</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">log_prob_negative</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>

        <span class="c1"># probability of being class i AND not being the others</span>
        <span class="n">log_prob_final</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">log_prob_i</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">log_prob_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_prob_positive</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log_prob_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_prob_negative</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">log_prob_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">log_prob_i</span><span class="p">))</span>
        <span class="n">log_prob_final</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">log_prob_final</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># prob = _tf.nn.softmax(log_prob_positive, axis=1)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">log_prob_final</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">entropy</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="n">ind_skew</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy_and_indicators</span><span class="p">(</span>
            <span class="n">prob</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">explained_var</span>
        <span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">mu</span><span class="p">,</span>
                  <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
                  <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
                  <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="n">sims</span><span class="p">,</span>
                  <span class="s2">&quot;entropy&quot;</span><span class="p">:</span> <span class="n">entropy</span><span class="p">,</span>
                  <span class="s2">&quot;uncertainty&quot;</span><span class="p">:</span> <span class="n">uncertainty</span><span class="p">,</span>
                  <span class="s2">&quot;indicators&quot;</span><span class="p">:</span> <span class="n">ind_skew</span><span class="p">,</span>
                  <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">output</span></div>
</div>



<div class="viewcode-block" id="SequentialGaussianIndicator">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.SequentialGaussianIndicator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SequentialGaussianIndicator</span><span class="p">(</span><span class="n">CategoricalGaussianIndicator</span><span class="p">):</span>
    <span class="c1"># def __init__(self, n_components, tol=1e-3, sharpness=1):</span>
    <span class="c1">#     super().__init__(n_components - 1, tol, sharpness)</span>

<div class="viewcode-block" id="SequentialGaussianIndicator.log_lik">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.SequentialGaussianIndicator.log_lik">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="n">is_boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">n_data</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mu</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># sequential logic</span>
        <span class="c1"># ones = _tf.ones_like(y[:, 0])</span>
        <span class="c1"># zeros = _tf.zeros_like(y[:, 0])</span>
        <span class="c1"># keep_vals = [_tf.where(_tf.greater(y[:, 0], 0.0), ones, zeros)]</span>
        <span class="c1"># contacts = _tf.where(_tf.equal(y[:, 0], 0.0), ones, zeros)</span>
        <span class="c1"># for i in range(1, self.size):</span>
        <span class="c1">#     # positives for class i</span>
        <span class="c1">#     k = _tf.where(_tf.greater(y[:, i], 0.0), ones, zeros)</span>
        <span class="c1">#</span>
        <span class="c1">#     # negatives up to class i-1</span>
        <span class="c1">#     k = _tf.where(_tf.logical_or(</span>
        <span class="c1">#         _tf.equal(k, 1.0), _tf.equal(keep_vals[i - 1], 1.0)),</span>
        <span class="c1">#         ones, zeros</span>
        <span class="c1">#     )</span>
        <span class="c1">#</span>
        <span class="c1">#     # contacts up to class i-1</span>
        <span class="c1">#     contacts = _tf.where(</span>
        <span class="c1">#         _tf.logical_or(</span>
        <span class="c1">#             _tf.equal(contacts, 1.0),</span>
        <span class="c1">#             _tf.equal(y[:, i], 0.0)</span>
        <span class="c1">#         ),</span>
        <span class="c1">#         ones, zeros</span>
        <span class="c1">#     )</span>
        <span class="c1">#     k = _tf.where(_tf.logical_or(</span>
        <span class="c1">#         _tf.equal(k, 1.0), _tf.equal(contacts, 1.0)),</span>
        <span class="c1">#         ones, zeros</span>
        <span class="c1">#     )</span>
        <span class="c1">#     keep_vals.append(k)</span>
        <span class="c1"># keep_vals = _tf.stack(keep_vals, axis=1)</span>

        <span class="c1"># mu = _tf.concat([</span>
        <span class="c1">#     _tf.ones([n_data, 1], _tf.float64),</span>
        <span class="c1">#     mu</span>
        <span class="c1"># ], axis=1)</span>
        <span class="c1"># var = _tf.concat([</span>
        <span class="c1">#     _tf.ones([n_data, 1], _tf.float64) * 1e-6,</span>
        <span class="c1">#     var</span>
        <span class="c1"># ], axis=1)</span>

        <span class="c1"># dist = _tfd.Normal(mu, _tf.sqrt(var + 1e-6))</span>
        <span class="c1"># prob_pos = dist.survival_function(self.tol)</span>

        <span class="c1"># # interference over previous classes</span>
        <span class="c1"># mu_int = [mu[:, 0, None]]</span>
        <span class="c1"># var_int = [var[:, 0, None]]</span>
        <span class="c1"># for i in range(1, self.size):</span>
        <span class="c1">#     dist_int = _tfd.Normal(</span>
        <span class="c1">#         _tf.concat(mu_int, axis=1),</span>
        <span class="c1">#         _tf.sqrt(_tf.concat(var_int, axis=1) + 1e-6))</span>
        <span class="c1">#     prob_pos_int = dist_int.survival_function(self.tol)</span>
        <span class="c1">#     for j in range(i):</span>
        <span class="c1">#         w = 1.0 - 2*prob_pos[:, i, None]*prob_pos_int[:, j, None]</span>
        <span class="c1">#         mu_int[j] = mu_int[j] * w</span>
        <span class="c1">#         var_int[j] = var_int[j] * w**2</span>
        <span class="c1">#     mu_int.append(mu[:, i, None])</span>
        <span class="c1">#     var_int.append(var[:, i, None])</span>
        <span class="c1"># mu_int = _tf.concat(mu_int, axis=1)</span>
        <span class="c1"># var_int = _tf.concat(var_int, axis=1)</span>
        <span class="c1">#</span>
        <span class="c1"># dist = _tfd.Normal(mu_int, _tf.sqrt(var_int + 1e-6))</span>
        <span class="c1"># prob_neg = dist.log_cdf(- self.tol)</span>
        <span class="c1"># prob_zero = _tf.math.log(</span>
        <span class="c1">#     dist.cdf(self.tol) - dist.cdf(- self.tol) + 1e-6)</span>
        <span class="c1"># prob_pos = dist.log_survival_function(self.tol)</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>
        <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">survival_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>

        <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">prob_neg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">prob_pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">prob_neg</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_neg</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">prob_neg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">prob_pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">prob_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">prob_neg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">prob_neg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">prob_pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">prob_zero</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob_pos</span> <span class="o">-</span> <span class="n">prob_neg</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob_neg</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob_pos</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
            <span class="n">prob_neg</span><span class="p">,</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                      <span class="n">prob_pos</span><span class="p">,</span>
                      <span class="n">prob_zero</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">has_value</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">has_value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">log_density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharpness</span></div>


<div class="viewcode-block" id="SequentialGaussianIndicator.predict">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.SequentialGaussianIndicator.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># n_data = _tf.shape(mu)[0]</span>
        <span class="c1"># mu = _tf.concat([</span>
        <span class="c1">#     _tf.ones([n_data, 1], _tf.float64),</span>
        <span class="c1">#     mu</span>
        <span class="c1"># ], axis=1)</span>
        <span class="c1"># var = _tf.concat([</span>
        <span class="c1">#     _tf.ones([n_data, 1], _tf.float64) * 1e-6,</span>
        <span class="c1">#     var</span>
        <span class="c1"># ], axis=1)</span>

        <span class="c1"># dist = _tfd.Normal(mu, _tf.sqrt(var + 1e-6))</span>
        <span class="c1"># prob_pos = dist.survival_function(self.tol)</span>
        <span class="c1">#</span>
        <span class="c1"># # interference over previous classes</span>
        <span class="c1"># mu_int = [mu[:, 0, None]]</span>
        <span class="c1"># var_int = [var[:, 0, None]]</span>
        <span class="c1"># for i in range(1, self.size):</span>
        <span class="c1">#     dist_int = _tfd.Normal(</span>
        <span class="c1">#         _tf.concat(mu_int, axis=1),</span>
        <span class="c1">#         _tf.sqrt(_tf.concat(var_int, axis=1) + 1e-6))</span>
        <span class="c1">#     prob_pos_int = dist_int.survival_function(self.tol)</span>
        <span class="c1">#     for j in range(i):</span>
        <span class="c1">#         w = 1.0 - 2 * prob_pos[:, i, None] * prob_pos_int[:, j, None]</span>
        <span class="c1">#         mu_int[j] = mu_int[j] * w</span>
        <span class="c1">#         var_int[j] = var_int[j] * w ** 2</span>
        <span class="c1">#     mu_int.append(mu[:, i, None])</span>
        <span class="c1">#     var_int.append(var[:, i, None])</span>
        <span class="c1"># mu_int = _tf.concat(mu_int, axis=1)</span>
        <span class="c1"># var_int = _tf.concat(var_int, axis=1)</span>
        <span class="c1">#</span>
        <span class="c1"># dist = _tfd.Normal(mu_int, _tf.sqrt(var_int + 1e-6))</span>
        <span class="c1"># log_prob_positive = dist.log_survival_function(self.tol)</span>
        <span class="c1"># log_prob_negative = dist.log_prob(- self.tol)</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>
        <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">survival_function</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">prob_neg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">prob_pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">prob_neg</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_neg</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">prob_neg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">prob_pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">prob_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">prob_neg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">prob_neg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">prob_pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">log_prob_negative</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob_neg</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">log_prob_positive</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob_pos</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="c1"># probability of being class i AND not being the others</span>
        <span class="n">log_prob_final</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">log_prob_i</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">log_prob_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_prob_positive</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log_prob_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_prob_negative</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">log_prob_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">(</span><span class="n">log_prob_i</span><span class="p">))</span>
        <span class="n">log_prob_final</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">log_prob_final</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">log_prob_final</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">entropy</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="n">ind_skew</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy_and_indicators</span><span class="p">(</span>
            <span class="n">prob</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">explained_var</span>
        <span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">mu</span><span class="p">,</span>
                  <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
                  <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
                  <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="n">sims</span><span class="p">,</span>
                  <span class="s2">&quot;entropy&quot;</span><span class="p">:</span> <span class="n">entropy</span><span class="p">,</span>
                  <span class="s2">&quot;uncertainty&quot;</span><span class="p">:</span> <span class="n">uncertainty</span><span class="p">,</span>
                  <span class="s2">&quot;indicators&quot;</span><span class="p">:</span> <span class="n">ind_skew</span><span class="p">,</span>
                  <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">output</span></div>
</div>



<span class="k">class</span><span class="w"> </span><span class="nc">_CompositionalLikelihood</span><span class="p">(</span><span class="n">_Likelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_components</span><span class="p">,</span> <span class="n">n_basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Identity</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compositional likelihood.</span>

<span class="sd">        Used to model compositional variables (i.e. multiple variables which</span>
<span class="sd">        are constrained to unit sum). Assumes the data sums to 1. Requires up</span>
<span class="sd">        to `N-1` latent variables for `N` components. Due to the non-linear</span>
<span class="sd">        constraint, employs Monte Carlo for training.</span>

<span class="sd">        A good contrast matrix can improve the modeling results. See the</span>
<span class="sd">        compositional data literature for how to build one. Good contrasts</span>
<span class="sd">        often involve major vs minor elements, oxides vs sulfides, etc.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_components : int</span>
<span class="sd">            Number of components in the composition.</span>
<span class="sd">        n_basis : int</span>
<span class="sd">            Number of latent variables to use. Default is `n_components-1`. A</span>
<span class="sd">            smaller value forces a PCA-like decomposition of the contrasts.</span>
<span class="sd">        contrast_matrix : array</span>
<span class="sd">            A `n_components-1` by `n_components` matrix of contrasts.</span>
<span class="sd">        warping : Warping</span>
<span class="sd">            A warping object to be applied to each contrast, trained</span>
<span class="sd">            independently.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_basis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_basis</span> <span class="o">=</span> <span class="n">n_components</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">n_basis</span> <span class="o">&gt;=</span> <span class="n">n_components</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n_basis must be smaller than n_components&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_basis</span> <span class="o">=</span> <span class="n">n_basis</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_basis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span> <span class="o">=</span> <span class="n">n_components</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span>
            <span class="s2">&quot;basis&quot;</span><span class="p">,</span>
            <span class="n">_gpr</span><span class="o">.</span><span class="n">OrthonormalMatrix</span><span class="p">(</span><span class="n">n_components</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_basis</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">contrast_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">contrast_matrix</span> <span class="o">=</span> <span class="n">_helmert</span><span class="p">(</span><span class="n">n_components</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">contrast_matrix</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_components</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_components</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid shape for contrast_matrix; &quot;</span>
                             <span class="s2">&quot;shape must be (n_components - 1, n_components)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">contrast_matrix</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">warpings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">(</span><span class="n">_copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">warping</span><span class="p">))</span>
                         <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_basis</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">white_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="n">n_data</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_distribution</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_data</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>  <span class="c1"># [n_var, n_data, n_samples] ?</span>
        <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">y_ilr</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">y_ilr</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">y_ilr</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>
        <span class="n">y_split</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">y_ilr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">y_warped</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">wp</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warpings</span><span class="p">,</span> <span class="n">y_split</span><span class="p">)],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">wp</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warpings</span><span class="p">,</span> <span class="n">y_split</span><span class="p">)]</span>
        <span class="n">log_derivative</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">y_derivative</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_distribution</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

        <span class="n">log_density</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">y_warped</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
            <span class="n">log_density</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">has_value</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">has_value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">lik</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">((</span><span class="n">log_density</span> <span class="o">+</span> <span class="n">log_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lik</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">rotated_contrast</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">basis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># ignores warping, used only for calculating weights</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">rotated_contrast</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">rotated_contrast</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">explained_var</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">explained_var</span><span class="p">,</span> <span class="n">rotated_contrast</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_noise</span><span class="p">:</span>
            <span class="n">sims</span> <span class="o">=</span> <span class="n">sims</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">white_noise</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">sims</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>

        <span class="c1"># backward warping</span>
        <span class="n">sims</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sims</span> <span class="o">=</span> <span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">s</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">wp</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warpings</span><span class="p">,</span> <span class="n">sims</span><span class="p">)]</span>
        <span class="n">sims</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># reverse ilr</span>
        <span class="n">sims_clr</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;nij,ik-&gt;nkj&quot;</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">rotated_contrast</span><span class="p">)</span>
        <span class="n">sims_simplex</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">sims_clr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># average composition (euclidean)</span>
        <span class="c1"># avg = _tf.reduce_mean(sims_clr, axis=2)</span>
        <span class="c1"># prob = _tf.nn.softmax(avg, axis=1)</span>

        <span class="c1"># average composition (simplex)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">sims_simplex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">explained_var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> \
                  <span class="o">/</span> <span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">mu</span><span class="p">,</span>
               <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">var</span><span class="p">,</span>
               <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="n">sims_simplex</span><span class="p">,</span>
               <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
               <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">y_ilr</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">y_centered</span> <span class="o">=</span> <span class="n">y_ilr</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">y_ilr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">y_centered</span><span class="p">,</span> <span class="n">y_centered</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">vals</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
        <span class="n">vecs</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">vecs</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fix</span><span class="p">()</span>

        <span class="n">y_ilr</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">y_ilr</span><span class="p">,</span> <span class="n">vecs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">wp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warpings</span><span class="p">):</span>
            <span class="n">wp</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">y_ilr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>


<div class="viewcode-block" id="CompositionalGaussian">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.CompositionalGaussian">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CompositionalGaussian</span><span class="p">(</span><span class="n">_CompositionalLikelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_components</span><span class="p">,</span> <span class="n">n_basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">tie_components</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Center</span><span class="p">()):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_components</span><span class="p">,</span> <span class="n">n_basis</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="p">,</span> <span class="n">warping</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tie_components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span>
                <span class="s2">&quot;noise&quot;</span><span class="p">,</span>
                <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span>
                <span class="s2">&quot;noise&quot;</span><span class="p">,</span>
                <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]))</span></div>



<div class="viewcode-block" id="CompositionalLaplace">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.CompositionalLaplace">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CompositionalLaplace</span><span class="p">(</span><span class="n">_CompositionalLikelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_components</span><span class="p">,</span> <span class="n">n_basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">tie_components</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Center</span><span class="p">()):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_components</span><span class="p">,</span> <span class="n">n_basis</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="p">,</span> <span class="n">warping</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tie_components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span>
                <span class="s2">&quot;rate&quot;</span><span class="p">,</span>
                <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span>
                <span class="s2">&quot;rate&quot;</span><span class="p">,</span>
                <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Laplace</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span></div>



<div class="viewcode-block" id="CompositionalEpsilonInsensitive">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.CompositionalEpsilonInsensitive">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CompositionalEpsilonInsensitive</span><span class="p">(</span><span class="n">_CompositionalLikelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_components</span><span class="p">,</span> <span class="n">n_basis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">tie_components</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warping</span><span class="o">=</span><span class="n">_warp</span><span class="o">.</span><span class="n">Center</span><span class="p">()):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_components</span><span class="p">,</span> <span class="n">n_basis</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="p">,</span> <span class="n">warping</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tie_components</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span>
                <span class="s2">&quot;epsilon&quot;</span><span class="p">,</span>
                <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span>
                <span class="s2">&quot;c_rate&quot;</span><span class="p">,</span>
                <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span>
                <span class="s2">&quot;epsilon&quot;</span><span class="p">,</span>
                <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span>
                <span class="s2">&quot;c_rate&quot;</span><span class="p">,</span>
                <span class="n">_gpr</span><span class="o">.</span><span class="n">PositiveParameter</span><span class="p">(</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">))</span>

<div class="viewcode-block" id="CompositionalEpsilonInsensitive.log_lik">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.CompositionalEpsilonInsensitive.log_lik">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;basis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">y_ilr</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">y_ilr</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">y_ilr</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>
        <span class="n">y_split</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">y_ilr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">y_warped</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">wp</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warpings</span><span class="p">,</span> <span class="n">y_split</span><span class="p">)],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="n">wp</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">wp</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warpings</span><span class="p">,</span> <span class="n">y_split</span><span class="p">)]</span>
        <span class="n">log_derivative</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">y_derivative</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">c_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;c_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">y_centered</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_warped</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">samples</span><span class="p">)</span>

        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">y_centered</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">),</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y_centered</span><span class="p">),</span>
            <span class="o">-</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_centered</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">log_density</span> <span class="o">=</span> <span class="n">log_density</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span><span class="p">))</span>
        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
            <span class="n">log_density</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">has_value</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">has_value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">lik</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">((</span><span class="n">log_density</span> <span class="o">+</span> <span class="n">log_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lik</span></div>


<div class="viewcode-block" id="CompositionalEpsilonInsensitive.inv_cdf">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.CompositionalEpsilonInsensitive.inv_cdf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">inv_cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;epsilon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">c_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;c_rate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>

        <span class="n">area</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">epsilon</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span><span class="p">)</span>
        <span class="c1"># p_1 = (1/c_rate - 2*epsilon) / area</span>
        <span class="c1"># p_2 = (1/c_rate) / area</span>
        <span class="n">p_1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">area</span>
        <span class="n">p_2</span> <span class="o">=</span> <span class="n">p_1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">epsilon</span> <span class="o">/</span> <span class="n">area</span>

        <span class="n">val_1</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">area</span> <span class="o">*</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="n">c_rate</span> <span class="o">-</span> <span class="n">epsilon</span>
        <span class="n">val_2</span> <span class="o">=</span> <span class="n">area</span> <span class="o">*</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">c_rate</span> <span class="o">-</span> <span class="n">epsilon</span>
        <span class="n">val_3</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">c_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">area</span> <span class="o">*</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">))</span> <span class="o">/</span> <span class="n">c_rate</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_1</span><span class="p">),</span> <span class="n">val_2</span><span class="p">,</span> <span class="n">val_1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_2</span><span class="p">),</span> <span class="n">val_3</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="CompositionalEpsilonInsensitive.white_noise">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.CompositionalEpsilonInsensitive.white_noise">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">white_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">minval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cdf</span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sample</span></div>
</div>



<div class="viewcode-block" id="OrderedGaussianIndicator">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.OrderedGaussianIndicator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderedGaussianIndicator</span><span class="p">(</span><span class="n">_CategoricalLikelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">sharpness</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharpness</span> <span class="o">=</span> <span class="n">sharpness</span>

        <span class="k">if</span> <span class="n">levels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_parameter</span><span class="p">(</span>
                <span class="s2">&quot;thresholds&quot;</span><span class="p">,</span>
                <span class="n">_gpr</span><span class="o">.</span><span class="n">CompositionalParameter</span><span class="p">(</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="p">)</span>

<div class="viewcode-block" id="OrderedGaussianIndicator.get_thresholds">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.OrderedGaussianIndicator.get_thresholds">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_thresholds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;thresholds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">thresholds</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thresholds</span></div>


<div class="viewcode-block" id="OrderedGaussianIndicator.log_lik">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.OrderedGaussianIndicator.log_lik">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span>
                <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">var</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>

        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prob_zero</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span> <span class="o">-</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_cdf</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
            <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>

            <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                <span class="n">prob_neg</span><span class="p">,</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                    <span class="n">prob_pos</span><span class="p">,</span>
                    <span class="n">prob_zero</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_thresholds</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">):</span>
                <span class="n">prob_zero</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                    <span class="o">-</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_cdf</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                    <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="n">dist</span><span class="o">.</span><span class="n">survival_function</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                        <span class="o">-</span> <span class="n">dist</span><span class="o">.</span><span class="n">survival_function</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                        <span class="o">+</span> <span class="mf">1e-6</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                        <span class="o">-</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                        <span class="o">+</span> <span class="mf">1e-6</span>
                    <span class="p">)</span>
                    <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_survival_function</span><span class="p">(</span>
                        <span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                        <span class="o">-</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                        <span class="o">+</span> <span class="mf">1e-6</span>
                    <span class="p">)</span>
                    <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="n">dist</span><span class="o">.</span><span class="n">survival_function</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                        <span class="o">-</span> <span class="n">dist</span><span class="o">.</span><span class="n">survival_function</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                        <span class="o">+</span> <span class="mf">1e-6</span>
                    <span class="p">)</span>

                <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">_tf</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                        <span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">prob_neg</span><span class="p">,</span>
                    <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">_tf</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                            <span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                            <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                        <span class="p">),</span>
                        <span class="n">prob_pos</span><span class="p">,</span>
                        <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">_tf</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                                <span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                                <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
                            <span class="p">),</span>
                            <span class="n">prob_zero</span><span class="p">,</span>
                            <span class="n">log_density</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># log_density_2 = _tf.math.log(- _tf.math.expm1(log_density))</span>
        <span class="c1"># log_density = log_density - log_density_2 #* 1e-2</span>

        <span class="n">has_value</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">has_value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># weights = 2 - _tf.math.exp(log_density)</span>
        <span class="c1"># weights = weights / _tf.reduce_sum(weights * has_value) \</span>
        <span class="c1">#           * _tf.reduce_sum(has_value)</span>

        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span> <span class="c1"># * weights)</span>

        <span class="k">return</span> <span class="n">log_density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharpness</span></div>


<div class="viewcode-block" id="OrderedGaussianIndicator.predict">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.OrderedGaussianIndicator.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="c1"># var = var * self.levels ** 2</span>
        <span class="c1"># explained_var = explained_var * self.levels ** 2</span>
        <span class="n">sims</span> <span class="o">=</span> <span class="n">sims</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="p">[</span><span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dist</span><span class="o">.</span><span class="n">survival_function</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thresholds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_thresholds</span><span class="p">()</span>

            <span class="n">prob</span> <span class="o">=</span> <span class="p">[</span><span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">prob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="o">-</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">survival_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">entropy</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="n">ind_skew</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy_and_indicators</span><span class="p">(</span>
            <span class="n">prob</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">explained_var</span>
        <span class="p">)</span>

        <span class="c1"># if self.levels &gt; 1:</span>
        <span class="c1">#     mu = mu - thresholds[None, :]</span>
        <span class="c1">#     sims = sims - thresholds[None, :, None]</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
                  <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span>
                  <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">sims</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                  <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span><span class="p">,</span>
                  <span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="n">prob</span><span class="p">,</span>
                  <span class="s2">&quot;entropy&quot;</span><span class="p">:</span> <span class="n">entropy</span><span class="p">,</span>
                  <span class="s2">&quot;uncertainty&quot;</span><span class="p">:</span> <span class="n">uncertainty</span><span class="p">,</span>
                  <span class="s2">&quot;indicators&quot;</span><span class="p">:</span> <span class="n">ind_skew</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">output</span></div>
</div>



<div class="viewcode-block" id="GradientIndicator">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.GradientIndicator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GradientIndicator</span><span class="p">(</span><span class="n">_Likelihood</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tol</span> <span class="o">=</span> <span class="n">tol</span>

<div class="viewcode-block" id="GradientIndicator.log_lik">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.GradientIndicator.log_lik">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_lik</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">has_value</span><span class="p">,</span>
                <span class="n">samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">_tfd</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>

        <span class="n">prob_zero</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span> <span class="o">-</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">prob_neg</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_cdf</span><span class="p">(</span><span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">prob_pos</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">log_survival_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">)</span>

        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
            <span class="n">prob_neg</span><span class="p">,</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">),</span>
                <span class="n">prob_pos</span><span class="p">,</span>
                <span class="n">prob_zero</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">has_value</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">has_value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log_density</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">log_density</span> <span class="o">*</span> <span class="n">has_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">log_density</span></div>


<div class="viewcode-block" id="GradientIndicator.predict">
<a class="viewcode-back" href="../../geoml.html#geoml.likelihood.GradientIndicator.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span><span class="p">,</span> <span class="n">explained_var</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">explained_var</span> <span class="o">/</span> <span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span>
                  <span class="s2">&quot;variance&quot;</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">var</span><span class="p">),</span>
                  <span class="s2">&quot;simulations&quot;</span><span class="p">:</span> <span class="n">sims</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                  <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">output</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Ítalo Gomes Gonçalves.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>