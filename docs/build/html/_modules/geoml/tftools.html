

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>geoml.tftools &mdash; geoML 0.3.5 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=ba50482b"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            geoML
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">geoml</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">geoML</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">geoml.tftools</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for geoml.tftools</h1><div class="highlight"><pre>
<span></span><span class="c1"># geoML - machine learning models for geospatial data</span>
<span class="c1"># Copyright (C) 2019  Ítalo Gomes Gonçalves</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR a PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_tf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_np</span>


<div class="viewcode-block" id="pairwise_dist">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.pairwise_dist">[docs]</a>
<span class="nd">@_tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span>
    <span class="n">input_signature</span><span class="o">=</span><span class="p">[</span><span class="n">_tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                     <span class="n">_tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pairwise_dist</span><span class="p">(</span><span class="n">mat_a</span><span class="p">,</span> <span class="n">mat_b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes pairwise distances between each elements of matrix and</span>
<span class="sd">    each elements of mat_b.</span>

<span class="sd">    Args:</span>
<span class="sd">    mat_a,    [m,d] matrix</span>
<span class="sd">    mat_b,    [n,d] matrix</span>

<span class="sd">    Returns:</span>
<span class="sd">    dist,    [m,n] matrix of pairwise distances</span>

<span class="sd">    code from</span>
<span class="sd">    https://gist.github.com/mbsariyildiz/34cdc26afb630e8cae079048eef91865</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;pairwise_dist&#39;</span><span class="p">):</span>
        <span class="c1"># squared norms of each row in matrix and mat_b</span>
        <span class="n">na</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">mat_a</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">mat_b</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># na as a row and nb as a column vectors</span>
        <span class="n">na</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># return pairwise euclidean difference matrix</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">na</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_a</span><span class="p">,</span> <span class="n">mat_b</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="n">nb</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dist</span></div>



<div class="viewcode-block" id="pairwise_dist_l1">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.pairwise_dist_l1">[docs]</a>
<span class="nd">@_tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span>
    <span class="n">input_signature</span><span class="o">=</span><span class="p">[</span><span class="n">_tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
                     <span class="n">_tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pairwise_dist_l1</span><span class="p">(</span><span class="n">mat_a</span><span class="p">,</span> <span class="n">mat_b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes L1 pairwise distances between each elements of matrix and</span>
<span class="sd">    each elements of mat_b.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s1">&#39;pairwise_dist_l1&#39;</span><span class="p">):</span>
        <span class="n">dif</span> <span class="o">=</span> <span class="n">mat_a</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">mat_b</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dif</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dist</span></div>



<div class="viewcode-block" id="training_step">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.training_step">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
    <span class="c1"># For some reason optimizer.minimize() is not present in TensorFlow v2.11 onwards</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">loss</span><span class="p">()</span>

    <span class="n">grads</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">variables</span><span class="p">))</span></div>



<div class="viewcode-block" id="composition_close">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.composition_close">[docs]</a>
<span class="nd">@_tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">composition_close</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Divides each row of a matrix by its sum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;composition_close&quot;</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">/</span> <span class="n">total</span>
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="prod_n">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.prod_n">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prod_n</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multiplies all input tensors element-wise.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inputs : list</span>
<span class="sd">        A list of Tensor objects, all with the same shape and type.</span>
<span class="sd">    name : str</span>
<span class="sd">        A name for the operation (optional).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A Tensor of same shape and type as the elements of inputs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;prod_n&quot;</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_prod</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="zero_nans">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.zero_nans">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">zero_nans</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">is_nan</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>



<div class="viewcode-block" id="ensure_rank_2">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.ensure_rank_2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_rank_2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                 <span class="k">lambda</span><span class="p">:</span> <span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span>
                 <span class="k">lambda</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>



<div class="viewcode-block" id="conjugate_gradient">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.conjugate_gradient">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">conjugate_gradient</span><span class="p">(</span><span class="n">matmul_fun</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x_0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span>
                       <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conjugate gradient solver.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matmul_fun : function</span>
<span class="sd">        Function to compute matrix times b. Must accept and return a single Tensor</span>
<span class="sd">        with the same shape as b.</span>
<span class="sd">    b : Tensor</span>
<span class="sd">        matrix vector with matching shape.</span>
<span class="sd">    x_0 : Tensor</span>
<span class="sd">        An initial guess at the solution. Defaults to zero.</span>
<span class="sd">    tol : double</span>
<span class="sd">        The tolerance for ending the loop. It is tested against the</span>
<span class="sd">        Frobenius norm of the residual matrix.</span>
<span class="sd">    jitter : double</span>
<span class="sd">        matrix small number to improve numerical stability.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x : Tensor</span>
<span class="sd">        The solution of the system Ax=b, where matrix is implicitly provided in</span>
<span class="sd">        matmul_fun.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;conjugate_gradient&quot;</span><span class="p">):</span>
        <span class="c1"># initialization</span>
        <span class="c1"># r = -b</span>
        <span class="k">if</span> <span class="n">x_0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_0</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">matmul_fun</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span>
        <span class="n">p</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span>
        <span class="c1"># x = _tf.zeros_like(b)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_0</span>
        <span class="n">rtr</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># TensorFlow loop</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">cond</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">p_</span><span class="p">,</span> <span class="n">x_</span><span class="p">,</span> <span class="n">rtr_</span><span class="p">):</span>

            <span class="n">cond_0</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">sx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">val</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">r_</span> <span class="o">*</span> <span class="n">r_</span><span class="p">))</span>
            <span class="n">cond_1</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>

            <span class="n">cond_2</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_all</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">cond_0</span><span class="p">,</span> <span class="n">cond_1</span><span class="p">,</span> <span class="n">cond_2</span><span class="p">]))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">body</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">p_</span><span class="p">,</span> <span class="n">x_</span><span class="p">,</span> <span class="n">rtr_</span><span class="p">):</span>
            <span class="n">ap</span> <span class="o">=</span> <span class="n">matmul_fun</span><span class="p">(</span><span class="n">p_</span><span class="p">)</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">rtr_</span> <span class="o">/</span> <span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">p_</span> <span class="o">*</span> <span class="n">ap</span><span class="p">)</span> <span class="o">+</span> <span class="n">jitter</span><span class="p">)</span>
            <span class="n">x_</span> <span class="o">=</span> <span class="n">x_</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">p_</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">ap</span>
            <span class="n">rtr_new</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">r_</span> <span class="o">*</span> <span class="n">r_</span><span class="p">)</span>
            <span class="n">p_</span> <span class="o">=</span> <span class="o">-</span><span class="n">r_</span> <span class="o">+</span> <span class="n">p_</span> <span class="o">*</span> <span class="n">rtr_new</span> <span class="o">/</span> <span class="p">(</span><span class="n">rtr_</span> <span class="o">+</span> <span class="n">jitter</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">p_</span><span class="p">,</span> <span class="n">x_</span><span class="p">,</span> <span class="n">rtr_new</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rtr</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span></div>



<div class="viewcode-block" id="conjugate_gradient_block">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.conjugate_gradient_block">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">conjugate_gradient_block</span><span class="p">(</span><span class="n">matmul_fun</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span>
                             <span class="n">x_0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conjugate gradient solver using the compressed feature matrix</span>
<span class="sd">    structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matmul_fun : function</span>
<span class="sd">        Function to compute matrix times b. Must accept and return a single Tensor</span>
<span class="sd">        with the same shape as b.</span>
<span class="sd">    b : Tensor</span>
<span class="sd">        matrix generic matrix with matching shape.</span>
<span class="sd">    tol : double</span>
<span class="sd">        The tolerance for ending the loop. It is tested against the</span>
<span class="sd">        Frobenius norm of the residual matrix.</span>
<span class="sd">    jitter : double</span>
<span class="sd">        matrix small number to improve numerical stability.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x : Tensor</span>
<span class="sd">        The solution of the system Ax=b, where matrix is implicitly provided in</span>
<span class="sd">        matmul_fun.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;conjugate_gradient_block&quot;</span><span class="p">):</span>
        <span class="c1"># initialization</span>
        <span class="k">if</span> <span class="n">x_0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_0</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="c1"># x = b</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">matmul_fun</span><span class="p">(</span><span class="n">x_0</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span>
        <span class="c1"># r = _tf.zeros_like(b)</span>
        <span class="c1"># qr_q, qr_r = _tf.linalg.qr(r)</span>
        <span class="c1"># r = qr_q</span>

        <span class="n">p</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span>
        <span class="c1"># x = _tf.zeros_like(b)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">tol</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="n">keep</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">fill</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">sx</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">update_cols</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">tensor_scatter_nd_update</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tensor</span><span class="p">),</span>
                <span class="n">indices</span><span class="p">,</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">updates</span><span class="p">)))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">add_to_cols</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">tensor_scatter_nd_add</span><span class="p">(</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tensor</span><span class="p">),</span>
                <span class="n">indices</span><span class="p">,</span>
                <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">updates</span><span class="p">)))</span>

        <span class="c1"># TensorFlow loop</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">cond</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">p_</span><span class="p">,</span> <span class="n">x_</span><span class="p">,</span> <span class="n">keep_</span><span class="p">):</span>
            <span class="c1"># cond_0 = _tf.less(i_, sx[0])</span>
            <span class="n">cond_0</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">)</span>
            <span class="n">cond_1</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_any</span><span class="p">(</span><span class="n">keep_</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">keep_</span><span class="p">)))</span>
            <span class="n">cond_2</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_all</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">cond_0</span><span class="p">,</span> <span class="n">cond_1</span><span class="p">,</span> <span class="n">cond_2</span><span class="p">]))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">body</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">p_</span><span class="p">,</span> <span class="n">x_</span><span class="p">,</span> <span class="n">keep_</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">keep_</span><span class="p">)))</span>
            <span class="n">r_sub</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">r_</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">p_sub</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">p_</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">rtr_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">r_sub</span><span class="p">,</span> <span class="n">r_sub</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="n">ap</span> <span class="o">=</span> <span class="n">matmul_fun</span><span class="p">(</span><span class="n">p_sub</span><span class="p">)</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">p_sub</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mat</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">mat</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jitter</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">rtr_</span><span class="p">)</span>
            <span class="n">r_sub</span> <span class="o">=</span> <span class="n">r_sub</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>

            <span class="n">idx</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x_</span> <span class="o">=</span> <span class="n">add_to_cols</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">p_sub</span><span class="p">,</span> <span class="n">alpha</span><span class="p">))</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">update_cols</span><span class="p">(</span><span class="n">r_</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r_sub</span><span class="p">)</span>

            <span class="c1"># unequal convergence</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_euclidean_norm</span><span class="p">(</span><span class="n">r_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">keep_new</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>

            <span class="n">rtr_new</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">r_sub</span><span class="p">,</span> <span class="n">r_sub</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">rtr_</span> <span class="o">=</span> <span class="n">rtr_</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">rtr_</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">rtr_</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">jitter</span>
            <span class="n">p_sub</span> <span class="o">=</span> <span class="o">-</span><span class="n">r_sub</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">p_sub</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">rtr_</span><span class="p">,</span> <span class="n">rtr_new</span><span class="p">))</span>
            <span class="n">p_</span> <span class="o">=</span> <span class="n">update_cols</span><span class="p">(</span><span class="n">p_</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">p_sub</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">p_</span><span class="p">,</span> <span class="n">x_</span><span class="p">,</span> <span class="n">keep_new</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">keep</span><span class="p">),</span>
                             <span class="n">swap_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">parallel_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># return _tf.matmul(out[3], qr_r)</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span></div>



<div class="viewcode-block" id="lanczos">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.lanczos">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">lanczos</span><span class="p">(</span><span class="n">matmul_fn</span><span class="p">,</span> <span class="n">q_0</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;lanczos&quot;</span><span class="p">):</span>
        <span class="n">q_0</span> <span class="o">=</span> <span class="n">q_0</span> <span class="o">/</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_euclidean_norm</span><span class="p">(</span><span class="n">q_0</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">matmul_fn</span><span class="p">(</span><span class="n">q_0</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">q_0</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">q_0</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_euclidean_norm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mat_q</span> <span class="o">=</span> <span class="n">q_0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">loop_fn</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">mat_q_</span><span class="p">,</span> <span class="n">beta_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">alpha_</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">[:,</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">beta_i</span> <span class="o">=</span> <span class="n">beta_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">q_i</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">/</span> <span class="n">beta_i</span>
            <span class="n">mat_q_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">q_i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">matmul_fn</span><span class="p">(</span><span class="n">q_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">beta_i</span> <span class="o">*</span> <span class="n">v</span>
            <span class="c1"># r_ = matmul_fn(q_i) - alpha_[-1]*q_i - beta_i * v</span>
            <span class="n">alpha_i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">q_i</span> <span class="o">*</span> <span class="n">r_</span><span class="p">)</span>
            <span class="n">alpha_i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">alpha_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">alpha_</span><span class="p">,</span> <span class="n">alpha_i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">-</span> <span class="n">alpha_i</span> <span class="o">*</span> <span class="n">q_i</span>

            <span class="c1"># reorthogonalization</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="c1"># r_ = r_ - _tf.matmul(mat_q_, _tf.matmul(mat_q_, r_, True, False))</span>

            <span class="n">beta_i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_euclidean_norm</span><span class="p">(</span><span class="n">r_</span><span class="p">)</span>
            <span class="n">beta_i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">beta_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">beta_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">beta_</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mat_q_</span><span class="p">,</span> <span class="n">beta_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">alpha_</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cond_fn</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">mat_q_</span><span class="p">,</span> <span class="n">beta_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">alpha_</span><span class="p">):</span>
            <span class="n">cond_0</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_all</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">cond_0</span><span class="p">]))</span>

        <span class="n">i</span><span class="p">,</span> <span class="n">mat_q</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span>
            <span class="n">cond_fn</span><span class="p">,</span> <span class="n">loop_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mat_q</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span><span class="p">),</span>
            <span class="n">shape_invariants</span><span class="o">=</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([]),</span>
                              <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]),</span>
                              <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">]),</span>
                              <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]),</span>
                              <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">])),</span>
            <span class="n">swap_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">parallel_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># keep = _tf.squeeze(_tf.where(_tf.greater(beta, 1e-12)))</span>
        <span class="c1"># keep = _tf.cond(_tf.greater(_tf.rank(keep), 0),</span>
        <span class="c1">#                 lambda: keep,</span>
        <span class="c1">#                 lambda: _tf.constant([0], keep.dtype))</span>
        <span class="c1"># beta = _tf.gather(beta, keep)</span>
        <span class="c1"># beta = _tf.cond(_tf.greater(_tf.rank(beta), 0),</span>
        <span class="c1">#                 lambda: beta,</span>
        <span class="c1">#                 lambda: _tf.expand_dims(beta, axis=0))</span>
        <span class="c1"># pos = _tf.shape(beta)[0]</span>
        <span class="c1"># alpha = alpha[0:pos]</span>
        <span class="c1"># mat_q = mat_q[:, 0:pos]</span>

        <span class="n">alpha_min</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">alpha_min</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="n">alpha</span> <span class="o">-</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">alpha_min</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">tensor_diag</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="c1"># beta = _tf.linalg.tensor_diag(</span>
        <span class="c1">#     _tf.concat([beta[0:(pos-1)], [0.0]], axis=0))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">tensor_diag</span><span class="p">(</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">mat_t</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mat_t</span><span class="p">,</span> <span class="n">mat_q</span></div>



<div class="viewcode-block" id="determinant_lanczos">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.determinant_lanczos">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">determinant_lanczos</span><span class="p">(</span><span class="n">matmul_fn</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;determinant_approximation_lanczos&quot;</span><span class="p">):</span>

        <span class="c1"># Rademacher random vectors</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">stateless_uniform</span><span class="p">([</span><span class="n">size</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="p">[</span><span class="n">seed</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                           <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                                           <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">rnd</span> <span class="o">/</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_euclidean_norm</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">loop_fn</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mat_t</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lanczos</span><span class="p">(</span><span class="n">matmul_fn</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">mat_t</span><span class="p">)</span>
            <span class="n">eigvals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">eigvals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">eig_min</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span>
            <span class="n">eigvals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">eig_min</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                               <span class="k">lambda</span><span class="p">:</span> <span class="n">eigvals</span><span class="p">,</span>
                               <span class="k">lambda</span><span class="p">:</span> <span class="n">eigvals</span> <span class="o">-</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">eig_min</span><span class="p">)</span>

            <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">eigvecs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">eigvecs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
                <span class="n">tau</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">det</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="n">loop_fn</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">rnd</span><span class="p">),</span>
                         <span class="n">swap_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">parallel_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logdet</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="n">n</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logdet</span></div>



<div class="viewcode-block" id="repeat_vector">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.repeat_vector">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">repeat_vector</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">repeat_each</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="kc">True</span><span class="p">)):</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;repeat_vector&quot;</span><span class="p">):</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">repeat_each</span><span class="p">,</span>
                       <span class="k">lambda</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                       <span class="k">lambda</span><span class="p">:</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">vec</span></div>



<div class="viewcode-block" id="sparse_kronecker_by_rows">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.sparse_kronecker_by_rows">[docs]</a>
<span class="nd">@_tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sparse_kronecker_by_rows</span><span class="p">(</span><span class="n">mat_x</span><span class="p">,</span> <span class="n">mat_y</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;sparse_kronecker_by_rows&quot;</span><span class="p">):</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mat_x</span><span class="p">),</span> <span class="n">_tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mat_y</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># pre-allocation</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">loop_fn</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">rows_</span><span class="p">,</span> <span class="n">cols_</span><span class="p">,</span> <span class="n">vals_</span><span class="p">):</span>
            <span class="n">slice_x</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">mat_x</span><span class="p">,</span> <span class="p">[</span><span class="n">i_</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">nx</span><span class="p">])</span>
            <span class="n">slice_y</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">mat_y</span><span class="p">,</span> <span class="p">[</span><span class="n">i_</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ny</span><span class="p">])</span>

            <span class="n">nvals_x</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">slice_x</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nvals_y</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">slice_y</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">vals_x</span> <span class="o">=</span> <span class="n">repeat_vector</span><span class="p">(</span><span class="n">slice_x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">nvals_y</span><span class="p">,</span>
                                   <span class="n">repeat_each</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">vals_y</span> <span class="o">=</span> <span class="n">repeat_vector</span><span class="p">(</span><span class="n">slice_y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">nvals_x</span><span class="p">)</span>
            <span class="n">vals_xy</span> <span class="o">=</span> <span class="n">vals_x</span> <span class="o">*</span> <span class="n">vals_y</span>

            <span class="n">cols_x</span> <span class="o">=</span> <span class="n">repeat_vector</span><span class="p">(</span><span class="n">slice_x</span><span class="o">.</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">nvals_y</span><span class="p">,</span>
                                   <span class="n">repeat_each</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">cols_y</span> <span class="o">=</span> <span class="n">repeat_vector</span><span class="p">(</span><span class="n">slice_y</span><span class="o">.</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">nvals_x</span><span class="p">)</span>
            <span class="n">cols_xy</span> <span class="o">=</span> <span class="n">cols_x</span> <span class="o">+</span> <span class="n">cols_y</span><span class="o">*</span><span class="n">nx</span>

            <span class="n">rows_xy</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cols_xy</span><span class="p">)</span> <span class="o">*</span> <span class="n">i_</span>

            <span class="c1"># update</span>
            <span class="n">rows_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">rows_</span><span class="p">,</span> <span class="n">rows_xy</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cols_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cols_</span><span class="p">,</span> <span class="n">cols_xy</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">vals_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">vals_</span><span class="p">,</span> <span class="n">vals_xy</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">i_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rows_</span><span class="p">,</span> <span class="n">cols_</span><span class="p">,</span> <span class="n">vals_</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cond_fn</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">rows_</span><span class="p">,</span> <span class="n">cols_</span><span class="p">,</span> <span class="n">vals_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">)</span>

        <span class="n">i</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span>
            <span class="n">cond_fn</span><span class="p">,</span> <span class="n">loop_fn</span><span class="p">,</span> <span class="n">loop_vars</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">vals</span><span class="p">],</span>
            <span class="n">parallel_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">shape_invariants</span><span class="o">=</span><span class="p">[</span><span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([]),</span> <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">]),</span>
                              <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">]),</span> <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">])]</span>
        <span class="p">)</span>

        <span class="c1"># output</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mat_new</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">SparseTensor</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span>
                                          <span class="n">dense_shape</span><span class="o">=</span><span class="p">[</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">mat_new</span></div>



<span class="c1"># def lanczos_conjgate_gradient(matmul_fn, size, n=100, m=100,</span>
<span class="c1">#                               seed=1234, tol=1e-6):</span>
<span class="c1">#     &quot;&quot;&quot;Matrix determinant based on conjugate gradients.</span>
<span class="c1">#</span>
<span class="c1">#     Based on Gardner et al. (2018)</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     with _tf.name_scope(&quot;lanczos_conjgate_gradient&quot;):</span>
<span class="c1">#</span>
<span class="c1">#         # Rademacher random vectors</span>
<span class="c1">#         rnd = _tf.random.stateless_uniform([size, n], [seed, 0],</span>
<span class="c1">#                                            dtype=_tf.float64,</span>
<span class="c1">#                                            minval=0, maxval=1)</span>
<span class="c1">#         rnd = _tf.round(rnd) * 2 - 1</span>
<span class="c1">#         rnd = rnd / _tf.math.reduce_euclidean_norm(rnd, axis=0, keepdims=True)</span>
<span class="c1">#</span>
<span class="c1">#         # initialization</span>
<span class="c1">#         mat_u = _tf.zeros_like(rnd)</span>
<span class="c1">#         mat_r = matmul_fn(mat_u) - rnd</span>
<span class="c1">#         mat_z = mat_r</span>
<span class="c1">#         mat_d = mat_z</span>
<span class="c1">#</span>
<span class="c1">#         alpha = _tf.zeros([0, n], _tf.float64)</span>
<span class="c1">#         beta = _tf.zeros([0, n], _tf.float64)</span>
<span class="c1">#         i = _tf.constant(0)</span>
<span class="c1">#</span>
<span class="c1">#         # conjugate gradient</span>
<span class="c1">#         def loop_fn(i_, alpha_, beta_, u_, r_, z_, d_):</span>
<span class="c1">#             mat_v = matmul_fn(d_)</span>
<span class="c1">#             alpha_i = _tf.reduce_sum(r_ * z_, axis=0, keepdims=True) \</span>
<span class="c1">#                 / _tf.reduce_sum(d_ * mat_v, axis=0, keepdims=True)</span>
<span class="c1">#             u_ = u_ + alpha_i * d_</span>
<span class="c1">#             r_ = r_ - alpha_i * mat_v</span>
<span class="c1">#</span>
<span class="c1">#             z_new = r_</span>
<span class="c1">#             beta_i = _tf.reduce_sum(z_new**2, axis=0, keepdims=True) \</span>
<span class="c1">#                 / _tf.reduce_sum(z_**2, axis=0, keepdims=True)</span>
<span class="c1">#             d_ = z_new - beta_i * d_</span>
<span class="c1">#</span>
<span class="c1">#             alpha_ = _tf.concat([alpha_, alpha_i], axis=0)</span>
<span class="c1">#             beta_ = _tf.concat([beta_, beta_i], axis=0)</span>
<span class="c1">#</span>
<span class="c1">#             return i_ + 1, alpha_, beta_, u_, r_, z_, d_</span>
<span class="c1">#</span>
<span class="c1">#         def cond_fn(i_, alpha_, beta_, u_, r_, z_, d_):</span>
<span class="c1">#             cond_0 = _tf.less(i_, m)</span>
<span class="c1">#             # cond_1 = _tf.less(_tf.sqrt(_tf.reduce_mean(r_*r_)),</span>
<span class="c1">#             #                   _tf.constant(tol, _tf.float64))</span>
<span class="c1">#             return _tf.reduce_all(_tf.stack([cond_0]))</span>
<span class="c1">#</span>
<span class="c1">#         i, alpha, beta, mat_u, mat_r, mat_z, mat_d = _tf.while_loop(</span>
<span class="c1">#             cond_fn, loop_fn,</span>
<span class="c1">#             (i, alpha, beta, mat_u, mat_r, mat_z, mat_d),</span>
<span class="c1">#             shape_invariants=(_tf.TensorShape([]),</span>
<span class="c1">#                               _tf.TensorShape([None, n]),</span>
<span class="c1">#                               _tf.TensorShape([None, n]),</span>
<span class="c1">#                               _tf.TensorShape([size, n]),</span>
<span class="c1">#                               _tf.TensorShape([size, n]),</span>
<span class="c1">#                               _tf.TensorShape([size, n]),</span>
<span class="c1">#                               _tf.TensorShape([size, n])),</span>
<span class="c1">#             swap_memory=False,</span>
<span class="c1">#             parallel_iterations=1)</span>
<span class="c1">#</span>
<span class="c1">#         # fixing numerical issues</span>
<span class="c1">#         alpha_min = _tf.reduce_min(alpha, axis=0, keepdims=True)</span>
<span class="c1">#         alpha = _tf.where(_tf.greater(alpha, 0.0),</span>
<span class="c1">#                           alpha,</span>
<span class="c1">#                           alpha - 1.01 * alpha_min)</span>
<span class="c1">#</span>
<span class="c1">#         # lanczos and determinant</span>
<span class="c1">#         final_m = _tf.shape(alpha)[0]</span>
<span class="c1">#         idx = _tf.range(final_m)</span>
<span class="c1">#</span>
<span class="c1">#         lanczos_beta = _tf.sqrt(beta) / alpha</span>
<span class="c1">#         lanczos_beta = _tf.gather(lanczos_beta, _tf.expand_dims(idx, axis=1))</span>
<span class="c1">#</span>
<span class="c1">#         beta_alpha = beta / alpha</span>
<span class="c1">#         beta_alpha = _tf.roll(beta_alpha, shift=1, axis=0)</span>
<span class="c1">#         beta_alpha = _tf.tensor_scatter_nd_update(</span>
<span class="c1">#             beta_alpha, [[0]], _tf.zeros([1, n], _tf.float64))</span>
<span class="c1">#         lanczos_alpha = 1/alpha + beta_alpha</span>
<span class="c1">#</span>
<span class="c1">#         lanczos_alpha = _tf.transpose(lanczos_alpha)</span>
<span class="c1">#         lanczos_beta = _tf.transpose(_tf.squeeze(lanczos_beta, axis=1))</span>
<span class="c1">#         batch_t = _tf.zeros([n, final_m, final_m], _tf.float64)</span>
<span class="c1">#         batch_t = _tf.linalg.set_diag(batch_t, lanczos_alpha) \</span>
<span class="c1">#                   + _tf.roll(_tf.linalg.set_diag(batch_t, lanczos_beta), 1, 2) \</span>
<span class="c1">#                   + _tf.roll(_tf.linalg.set_diag(batch_t, lanczos_beta), 1, 1)</span>
<span class="c1">#</span>
<span class="c1">#         eigvals, eigvecs = _tf.linalg.eigh(batch_t)</span>
<span class="c1">#         eigvals = _tf.maximum(eigvals, 1e-9)</span>
<span class="c1">#         first_row = eigvecs[:, 0, :]</span>
<span class="c1">#</span>
<span class="c1">#         logdet = _tf.cast(size, _tf.float64) * _tf.reduce_mean(</span>
<span class="c1">#             _tf.reduce_sum(first_row**2 * _tf.math.log(eigvals), axis=1)</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#     return logdet</span>


<div class="viewcode-block" id="lanczos_gp_solve">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.lanczos_gp_solve">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">lanczos_gp_solve</span><span class="p">(</span><span class="n">matmul_fn</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lanczos decomposition and determinant estimation&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">_tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="s2">&quot;lanczos_gp_solve&quot;</span><span class="p">):</span>
        <span class="n">n_data</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Rademacher random vectors</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">stateless_uniform</span><span class="p">([</span><span class="n">n_data</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="p">[</span><span class="n">seed</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                           <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                                           <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rnd</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">rnd</span> <span class="o">/</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_euclidean_norm</span><span class="p">(</span><span class="n">rnd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># initialization</span>
        <span class="n">q_0</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">rnd</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">q_0</span> <span class="o">=</span> <span class="n">q_0</span> <span class="o">/</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_euclidean_norm</span><span class="p">(</span><span class="n">q_0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">matmul_fn</span><span class="p">(</span><span class="n">q_0</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">q_0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># [it, n+1]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">q_0</span>  <span class="c1"># [n_data, n+1]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_euclidean_norm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">mat_q</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">q_0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [it, n_data, n+1]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># batch lanczos</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">loop_fn</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">mat_q_</span><span class="p">,</span> <span class="n">beta_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">alpha_</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">mat_q_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># [n_data, n+1]</span>
            <span class="n">beta_i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">beta_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># [1, n+1]</span>
            <span class="n">q_i</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">/</span> <span class="n">beta_i</span>
            <span class="n">mat_q_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">q_i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">matmul_fn</span><span class="p">(</span><span class="n">q_i</span><span class="p">)</span> <span class="o">-</span> <span class="n">beta_i</span> <span class="o">*</span> <span class="n">v</span>
            <span class="n">alpha_i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">q_i</span> <span class="o">*</span> <span class="n">r_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">alpha_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">alpha_</span><span class="p">,</span> <span class="n">alpha_i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">-</span> <span class="n">alpha_i</span> <span class="o">*</span> <span class="n">q_i</span>

            <span class="c1"># reorthogonalization</span>
            <span class="n">mat_q_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># [n+1, n_data, it]</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">r_</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># [n+1, n_data, 1]</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">r_</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">r_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">r_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">mat_q_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat_q_</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="n">beta_i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_euclidean_norm</span><span class="p">(</span><span class="n">r_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">beta_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">beta_</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mat_q_</span><span class="p">,</span> <span class="n">beta_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">alpha_</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">cond_fn</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">mat_q_</span><span class="p">,</span> <span class="n">beta_</span><span class="p">,</span> <span class="n">r_</span><span class="p">,</span> <span class="n">alpha_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>

        <span class="n">i</span><span class="p">,</span> <span class="n">mat_q</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span>
            <span class="n">cond_fn</span><span class="p">,</span> <span class="n">loop_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mat_q</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">alpha</span><span class="p">),</span>
            <span class="n">shape_invariants</span><span class="o">=</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([]),</span>
                              <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]),</span>
                              <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]),</span>
                              <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]),</span>
                              <span class="n">_tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])),</span>
            <span class="n">swap_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">parallel_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># post-processing</span>
        <span class="n">alpha_min</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                          <span class="n">alpha</span><span class="p">,</span>
                          <span class="n">alpha</span> <span class="o">-</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">alpha_min</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">),</span>
                         <span class="n">beta</span><span class="p">,</span>
                         <span class="n">_tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-12</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">:]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">beta</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># determinant</span>
        <span class="n">batch_t</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">batch_t</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">set_diag</span><span class="p">(</span><span class="n">batch_t</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span> \
                  <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">set_diag</span><span class="p">(</span><span class="n">batch_t</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">beta</span><span class="p">)),</span>
                                                 <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> \
                  <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">set_diag</span><span class="p">(</span><span class="n">batch_t</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">beta</span><span class="p">)),</span>
                                                 <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">batch_t</span><span class="p">)</span>
        <span class="n">eigvals</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">eigvals</span><span class="p">,</span> <span class="mf">1e-9</span><span class="p">)</span>
        <span class="n">first_row</span> <span class="o">=</span> <span class="n">eigvecs</span><span class="p">[</span><span class="mi">1</span><span class="p">::,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">logdet</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">n_data</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
            <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">first_row</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eigvals</span><span class="p">[</span><span class="mi">1</span><span class="p">::,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># decomposition for solving the system</span>
        <span class="n">eigvals_system</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">1e-9</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">eigvals_system</span><span class="p">))</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">eigvecs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">phi</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">mat_q</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">phi</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">solved</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">solved</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">solved</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">phi</span><span class="p">,</span> <span class="n">solved</span><span class="p">,</span> <span class="n">logdet</span></div>



<div class="viewcode-block" id="highest_value_probability">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.highest_value_probability">[docs]</a>
<span class="nd">@_tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span><span class="w"> </span><span class="nf">highest_value_probability</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">n_data</span><span class="p">,</span> <span class="n">n_values</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">rnd</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">stateless_normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_values</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">-</span> <span class="n">n_values</span><span class="p">],</span>
                                      <span class="n">seed</span><span class="o">=</span><span class="p">[</span><span class="n">seed</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">rnd</span> <span class="o">+</span> <span class="n">_tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">max_ind</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># def count_fn(i):</span>
    <span class="c1">#     which = _tf.cast(_tf.equal(max_ind, i), _tf.float32)</span>
    <span class="c1">#     return _tf.reduce_sum(which, axis=1) + 1.0</span>
    <span class="c1">#</span>
    <span class="c1"># counts = _tf.map_fn(count_fn, _tf.range(n_values, dtype=_tf.int64),</span>
    <span class="c1">#                     dtype=_tf.float32)</span>
    <span class="c1"># counts = _tf.transpose(counts)</span>

    <span class="n">counts</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span>
        <span class="n">max_ind</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_values</span><span class="p">,</span> <span class="n">maxlength</span><span class="o">=</span><span class="n">n_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">+</span> <span class="mf">1.0</span>

    <span class="n">prob</span> <span class="o">=</span> <span class="n">counts</span><span class="o">/</span><span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prob</span></div>



<div class="viewcode-block" id="reshape_lower_traingular">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.reshape_lower_traingular">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reshape_lower_traingular</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">vec</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cast</span><span class="p">((</span><span class="n">_tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tril_indices</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span><span class="n">tril_indices</span><span class="p">,</span> <span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="p">[</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">mat</span></div>



<div class="viewcode-block" id="get_lower_triangular">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.get_lower_triangular">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_lower_triangular</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tril_indices</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span><span class="n">tril_indices</span><span class="p">,</span> <span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">_tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mat</span></div>



<div class="viewcode-block" id="grid_laplacian">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.grid_laplacian">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">grid_laplacian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Laplacian along tensor axis.</span>

<span class="sd">    This function computes the Laplacian along the specified axis of a tensor.</span>

<span class="sd">    The operation can be made computationally efficient based on the fact that,</span>
<span class="sd">    on a regular grid, the Laplacian can be computed as a Kronecker sum of the</span>
<span class="sd">    Laplacians on each individual dimension.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : _tf.Tensor</span>
<span class="sd">        Tensor on which to compute the Laplacian.</span>
<span class="sd">    axis : list</span>
<span class="sd">        List indicating on which axes to compute the Laplacian</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lap : _tf.Tensor</span>
<span class="sd">        A tensor with the same shape as `x`, with the Laplacian computed</span>
<span class="sd">        along the specified axes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">lap</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">laplacian</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">axis_</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x_</span><span class="p">)[</span><span class="n">axis_</span><span class="p">]</span>
        <span class="n">x_rev</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="p">[</span><span class="n">axis_</span><span class="p">])</span>

        <span class="n">dummy</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis_</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis_</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x_rev</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis_</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> \
            <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x_rev</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis_</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="n">axis_</span><span class="p">])</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dummy</span><span class="p">),</span> <span class="n">a</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis_</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dummy</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_fn</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">lap_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">i_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lap_</span> <span class="o">+</span> <span class="n">laplacian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis_</span><span class="o">=</span><span class="n">axis</span><span class="p">[</span><span class="n">i_</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cond_fn</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">lap_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">i</span><span class="p">,</span> <span class="n">lap</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond_fn</span><span class="p">,</span> <span class="n">loop_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lap</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">lap</span></div>



<div class="viewcode-block" id="masked_laplacian">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.masked_laplacian">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">masked_laplacian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Laplacian along tensor axis.</span>

<span class="sd">    This function computes the Laplacian along the specified axis of a tensor.</span>

<span class="sd">    The operation can be made computationally efficient based on the fact that,</span>
<span class="sd">    on a regular grid, the Laplacian can be computed as a Kronecker sum of the</span>
<span class="sd">    Laplacians on each individual dimension.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : _tf.Tensor</span>
<span class="sd">        Tensor on which to compute the Laplacian.</span>
<span class="sd">    axis : list</span>
<span class="sd">        List indicating on which axes to compute the Laplacian</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lap : _tf.Tensor</span>
<span class="sd">        A tensor with the same shape as `x`, with the Laplacian computed</span>
<span class="sd">        along the specified axes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">lap</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">laplacian</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">axis_</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x_</span><span class="p">)[</span><span class="n">axis_</span><span class="p">]</span>
        <span class="n">x_rev</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="p">[</span><span class="n">axis_</span><span class="p">])</span>

        <span class="n">dummy</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis_</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis_</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x_rev</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis_</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> \
            <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x_rev</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis_</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="n">axis_</span><span class="p">])</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">mask_1</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis_</span><span class="p">)</span>
        <span class="n">mask_2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis_</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">mask_1</span> <span class="o">*</span> <span class="n">mask_2</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">mask_1</span> <span class="o">*</span> <span class="n">mask_2</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dummy</span><span class="p">),</span> <span class="n">a</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis_</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dummy</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loop_fn</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">lap_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">i_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lap_</span> <span class="o">+</span> <span class="n">laplacian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis_</span><span class="o">=</span><span class="n">axis</span><span class="p">[</span><span class="n">i_</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cond_fn</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">lap_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="n">i</span><span class="p">,</span> <span class="n">lap</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond_fn</span><span class="p">,</span> <span class="n">loop_fn</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lap</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">lap</span></div>



<div class="viewcode-block" id="sparsemax">
<a class="viewcode-back" href="../../geoml.html#geoml.tftools.sparsemax">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sparsemax</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sparsemax function (Martins and Astudillo, 2016)</span>

<span class="sd">    Projection of a point on the unit simplex.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    z : _tf.Tensor</span>
<span class="sd">        Tensor containing the points to project.</span>
<span class="sd">    axis : int</span>
<span class="sd">        Axis on which to operate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    p : _tf.Tensor</span>
<span class="sd">        Tensor containing the projected points.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="n">z_sort</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;DESCENDING&#39;</span><span class="p">)</span>
    <span class="n">z_add</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">seq</span> <span class="o">*</span> <span class="n">z_sort</span>
    <span class="n">z_cum</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">z_sort</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="n">ind</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">_tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">z_add</span><span class="p">,</span> <span class="n">z_cum</span><span class="p">),</span> <span class="n">_tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">z_cum</span><span class="p">),</span> <span class="n">_tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z_cum</span><span class="p">))</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">z_cum_k</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">z_sort</span> <span class="o">*</span> <span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">tau</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_cum_k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">_tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Ítalo Gomes Gonçalves.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>